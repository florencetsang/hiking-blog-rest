#Parameters:
#  ebS3Bucket:
#    Type: CommaDelimitedList
#    Description: "Name of the Amazon S3 bucket that contains your file"
#    Default:
#      "Fn::Sub": "elasticbeanstalk-${AWS::Region}-${AWS::AccountId}"
#  ebS3AuthRole:
#    Type: String
#    Description: "Role with permissions to download the file from Amazon S3"
#    Default: "aws-elasticbeanstalk-ec2-role"

Resources:
  AWSEBAutoScalingGroup:
    Metadata:
      AWS::CloudFormation::Authentication:
        S3Auth:
          type: "s3"
          buckets:
            - "Fn::Sub": "elasticbeanstalk-${AWS::Region}-${AWS::AccountId}"
          roleName:
            "Fn::GetOptionSetting":
              Namespace: "aws:autoscaling:launchconfiguration"
              OptionName: "IamInstanceProfile"
              DefaultValue: "aws-elasticbeanstalk-ec2-role"

option_settings:
  aws:elasticbeanstalk:application:environment:
    # default environment properties
    PORT: 5000
    GOOGLE_APPLICATION_CREDENTIALS: /tmp/google-credentials.json
    # https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/environments-cfg-softwaresettings.html
    # If you use an AWS CloudFormation function to define an environment property, the Elastic Beanstalk console displays the value of the property before the function is evaluated. You can use the get-config platform script to confirm the values of environment properties that are available to your application.
    # https://docs.aws.amazon.com/elasticbeanstalk/latest/dg/custom-platforms-scripts.html
    # /opt/elasticbeanstalk/bin/get-config environment
    JDBC_DATABASE_URL: '`{"Fn::Join": ["", ["jdbc:mysql://", {"Fn::GetAtt": ["AWSEBRDSDatabase", "Endpoint.Address"]}, ":", {"Fn::GetAtt": ["AWSEBRDSDatabase", "Endpoint.Port"]}, "/", {"Ref": "AWSEBDBName"}]]}`'
    JDBC_DATABASE_USERNAME: '`{"Ref": "AWSEBDBUser"}`'
    JDBC_DATABASE_PASSWORD: '`{"Ref": "AWSEBDBPassword"}`'
    # required environment properties
    # GOOGLE_CREDENTIALS_S3_PATH

files:
  # download Google credentials JSON from S3
  "/tmp/google-credentials.json" :
    mode: "000444"
    owner: root
    group: root
    authentication: "S3Auth"
    source:
      "Fn::Sub":
        - '${EBS3Url}/${FilePath}'
        - EBS3Url:
            "Fn::Sub": 'https://elasticbeanstalk-${AWS::Region}-${AWS::AccountId}.s3.${AWS::Region}.amazonaws.com'
          FilePath:
            "Fn::GetOptionSetting":
              Namespace: "aws:elasticbeanstalk:application:environment"
              # to-be defined from environment properties
              OptionName: "GOOGLE_CREDENTIALS_S3_PATH"